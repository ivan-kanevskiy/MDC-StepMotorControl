[env:olimex_e407]
platform = ststm32
board = olimex_e407
framework = arduino

; 1. Tell PlatformIO we are using a custom tool
upload_protocol = custom
debug_tool = custom

; 2. Configure the debug server to use OpenOCD with the Tiny-H and STM32F4 scripts
debug_server =
  ${platformio.packages_dir}/tool-openocd/bin/openocd
  -f
  interface/ftdi/olimex-arm-usb-tiny-h.cfg
  -f
  target/stm32f4x.cfg

; Optional but highly recommended: explicitly set the GDB port
debug_port = localhost:3333

; 3. Configure the exact command used for uploading the code
upload_command = $PROJECT_PACKAGES_DIR/tool-openocd/bin/openocd -f interface/ftdi/olimex-arm-usb-tiny-h.cfg -f target/stm32f4x.cfg -c "program {$SOURCE} 0x08000000 verify reset; shutdown"
; --- (Keep these below if you are using the Native USB for Serial) ---
build_flags = 
    -D PIO_FRAMEWORK_ARDUINO_ENABLE_CDC
    -D USBCON
monitor_speed = 115200